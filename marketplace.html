<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markets • Transactify Protocol</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --neon-blue: #00d4ff;
      --neon-purple: #a259ff;
      --neon-green: #00ff88;
      --neon-red: #ff0055;
      --dark-bg: #0a0e27;
      --darker-bg: #050814;
      --card-bg: rgba(15, 23, 42, 0.6);
      --border: rgba(0, 212, 255, 0.2);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --glass: rgba(255, 255, 255, 0.03);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--darker-bg);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .grid-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
      animation: grid 30s linear infinite;
    }

    @keyframes grid { from {transform: translate(0,0);} to {transform: translate(40px,40px);} }

    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(5, 8, 20, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }

    nav {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.25rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      font-family: 'Space Mono', monospace;
      color: var(--neon-blue);
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      text-decoration: none;
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      text-decoration: none;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Space Mono', monospace;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
      color: white;
      border: 1px solid var(--neon-blue);
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--neon-blue);
      border: 1px solid var(--neon-blue);
      backdrop-filter: blur(10px);
    }

    .hero-banner {
      position: relative;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 4rem 2rem;
      text-align: center;
    }

    .hero-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--neon-blue), var(--neon-purple), transparent);
    }

    .hero-banner h1 {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 800;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #fff, var(--neon-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-banner p {
      font-size: 1.125rem;
      color: var(--text-secondary);
      max-width: 700px;
      margin: 0 auto;
    }

    main {
      position: relative;
      max-width: 1600px;
      margin: 0 auto;
      padding: 3rem 2rem;
      z-index: 10;
    }

    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
      gap: 2rem;
      flex-wrap: wrap;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 1.5rem;
      border-radius: 1rem;
      border: 1px solid var(--border);
    }

    .filter-group {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.625rem 1.25rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.3s;
      font-family: 'Space Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .filter-btn:hover,
    .filter-btn.active {
      border-color: var(--neon-blue);
      color: var(--neon-blue);
      background: rgba(0, 212, 255, 0.1);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
    }

    .search-box {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .search-box input {
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-primary);
      font-size: 0.875rem;
      min-width: 260px;
      backdrop-filter: blur(10px);
      font-family: 'Space Mono', monospace;
    }

    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 2rem;
    }

    .listing-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all 0.3s;
      position: relative;
    }

    .listing-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s;
    }

    .listing-card:hover::before {
      transform: scaleX(1);
    }

    .listing-card:hover {
      border-color: var(--neon-blue);
      transform: translateY(-8px);
      box-shadow: 0 20px 50px rgba(0, 212, 255, 0.3);
    }

    .card-header {
      padding: 1.75rem;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      font-family: 'Space Mono', monospace;
    }

    .verification-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.875rem;
      border-radius: 2rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .badge-verified {
      background: rgba(0, 255, 136, 0.15);
      color: var(--neon-green);
      border: 1px solid var(--neon-green);
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
    }

    .badge-pending {
      background: rgba(162, 89, 255, 0.15);
      color: var(--neon-purple);
      border: 1px solid var(--neon-purple);
      box-shadow: 0 0 20px rgba(162, 89, 255, 0.2);
    }

    .badge-rejected {
      background: rgba(255, 0, 85, 0.15);
      color: var(--neon-red);
      border: 1px solid var(--neon-red);
    }

    .card-body {
      padding: 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .price-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .price-item {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      text-align: center;
    }

    .price-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
    }

    .price-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-primary);
      font-family: 'Space Mono', monospace;
    }

    .status-section {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      font-family: 'Space Mono', monospace;
    }

    .status-row:last-child { margin-bottom: 0; }
    .status-label { color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; }
    .countdown { display:inline-flex; align-items:center; gap:0.5rem; padding:0.5rem 1rem; border-radius:0.5rem; font-family:'Space Mono',monospace; font-size:0.85rem; }
    .countdown.live { background:linear-gradient(135deg,var(--neon-blue),var(--neon-purple)); color:#fff; box-shadow:0 0 20px rgba(0,212,255,0.3); }
    .countdown.ended { background:rgba(148,163,184,0.15); color:var(--text-secondary); }

    .card-footer {
      padding: 1.25rem 1.75rem;
      background: rgba(0, 0, 0, 0.4);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.85rem;
    }

    .loading,
    .empty-state {
      text-align: center;
      padding: 6rem 2rem;
      background: var(--card-bg);
      border-radius: 1rem;
      border: 1px solid var(--border);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 3px solid var(--border);
      border-top-color: var(--neon-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .listings-grid { grid-template-columns: 1fr; }
      .controls-bar { flex-direction: column; align-items: stretch; }
      .search-box { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="grid-background"></div>
  <header>
    <nav>
      <a href="index.html" class="logo">TRANSACTIFY</a>
      <div class="nav-actions">
        <a href="index.html" class="btn btn-secondary">← Protocol</a>
        <a href="dashboard.html" class="btn btn-primary">Launch dApp</a>
      </div>
    </nav>
  </header>

  <div class="hero-banner">
    <h1>Property Markets</h1>
    <p>Live oracle-verified listings across the protocol. All auctions are trustless with automated escrow.</p>
  </div>

  <main>
      <div class="controls-bar">
        <div class="filter-group">
        <button class="filter-btn" data-filter="all">All</button>
        <button class="filter-btn active" data-filter="live">Live Auctions</button>
        <button class="filter-btn" data-filter="transfer">Awaiting Transfer</button>
        <button class="filter-btn" data-filter="sold">Sold</button>
        <button class="filter-btn" data-filter="failed">Cancelled/Refunded</button>
        </div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search property ID...">
        <button class="btn btn-primary" onclick="refreshListings()">↻ Refresh</button>
      </div>
    </div>

    <div id="listingsContainer">
      <div class="loading">
        <div class="spinner"></div>
        <p>Querying blockchain...</p>
      </div>
    </div>
  </main>

  <script>
    const ethersLib = window.ethers;
    const PROVIDER_URL = "wss://sepolia.gateway.tenderly.co/2iN1RFRS9IywHeIVSg5lfR";
    const CONTRACTS = {
      titleRegistry: "0x375292e685BAa1e3160a2b99aaeb2F3AAf6BF541",
      marketplace: "0x53Bfef2fb9BF8b9729dBB35e138dbb8aF20B59a2"
    };

    const marketplaceABI = [
      "function totalListings() external view returns(uint256)",
      "function getListing(uint256) external view returns((string,address,address,uint64,uint64,uint64,uint128,uint128,uint128,uint256,address,uint8,bool))"
    ];

    const titleABI = [
      "function propertyInfo(string) external view returns(address,uint8,string,string,string,string,string,string,bool)"
    ];

    const VERIFY_LABELS = ["None", "Pending", "Verified", "Rejected"];
    const STATE_LABELS = ["Auction", "Escrow", "Settled", "Refunded", "Cancelled"];

    let allListings = [];
    let activeFilter = 'live';

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        activeFilter = e.target.dataset.filter;
        renderListings();
      });
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
      renderListings(e.target.value);
    });

    function formatCountdown(seconds) {
      if (seconds <= 0) return 'Ended';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      if (h > 0) return `${h}h ${m}m`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }

    function startCountdowns() {
      setInterval(() => {
        document.querySelectorAll('.countdown').forEach(el => {
          const endTime = parseInt(el.dataset.endtime);
          const now = Math.floor(Date.now() / 1000);
          const remaining = endTime - now;
          if (remaining > 0) {
            el.textContent = `⏱ ${formatCountdown(remaining)}`;
            el.classList.remove('ended');
          } else {
            el.textContent = '⏱ Ended';
            el.classList.add('ended');
          }
        });
      }, 1000);
    }

    function renderListings(searchTerm = '') {
      const container = document.getElementById('listingsContainer');
      let filtered = allListings.filter(listing => {
        if (activeFilter === 'live' && listing.state !== 0) return false;
        if (activeFilter === 'transfer' && listing.state !== 1) return false;
        if (activeFilter === 'sold' && listing.state !== 2) return false;
        if (activeFilter === 'failed' && listing.state !== 3 && listing.state !== 4) return false;
        if (searchTerm && !listing.propertyId.toLowerCase().includes(searchTerm.toLowerCase())) return false;
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No Properties Found</h3>
            <p>${searchTerm ? 'Try adjusting your search' : 'Deploy the first listing on this protocol'}</p>
            <a href="dashboard.html" class="btn btn-primary">Launch dApp</a>
          </div>
        `;
        return;
      }

      container.innerHTML = `<div class="listings-grid">${filtered.map(createListingCard).join('')}</div>`;
      startCountdowns();
    }

    function formatLocation(listing) {
      const parts = [listing.street, listing.city, listing.state].filter(Boolean);
      const line = parts.join(", ");
      if (listing.postalCode) {
        return `${line} ${listing.postalCode}`.trim();
      }
      return line || "No address info";
    }

    function createListingCard(listing) {
      const verifyClass = listing.verification === 2 ? 'badge-verified' : listing.verification === 1 ? 'badge-pending' : 'badge-rejected';
      const verifyIcon = listing.verification === 2 ? '✓' : listing.verification === 1 ? '◷' : '✗';
      const now = Math.floor(Date.now() / 1000);
      const timeRemaining = listing.biddingEnd - now;
      return `
        <div class="listing-card">
          <div class="card-header">
            <div class="card-title">
              <span>${listing.propertyId}</span>
              <span class="verification-badge ${verifyClass}">${verifyIcon} ${VERIFY_LABELS[listing.verification]}</span>
            </div>
            <div class="card-meta">
              <span>Listed: ${new Date(listing.createdAt * 1000).toLocaleDateString()}</span>
              <span>State: ${STATE_LABELS[listing.state]}</span>
            </div>
            <div class="card-meta">
              <span>${formatLocation(listing)}</span>
              <span>${listing.country || ""}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="price-grid">
              <div class="price-item">
                <div class="price-label">Reserve</div>
                <div class="price-value">${listing.reservePrice} Ξ</div>
              </div>
              <div class="price-item">
                <div class="price-label">Highest Bid</div>
                <div class="price-value">${listing.highestBid} Ξ</div>
              </div>
            </div>
            ${listing.buyNowPrice > 0 ? `<div class="price-item">
              <div class="price-label">Buy Now</div>
              <div class="price-value">${listing.buyNowPrice} Ξ</div>
            </div>` : ''}
            <div class="status-section">
              <div class="status-row">
                <span class="status-label">Auction</span>
                ${listing.state === 0 ? `<span class="countdown live" data-endtime="${listing.biddingEnd}">⏱ ${formatCountdown(timeRemaining)}</span>` : `<span class="countdown ended">${STATE_LABELS[listing.state]}</span>`}
              </div>
              <div class="status-row">
                <span class="status-label">Seller</span>
                <span>${listing.seller.slice(0,6)}…${listing.seller.slice(-4)}</span>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <div>${listing.agent !== ethersLib.ZeroAddress ? `Agent: ${listing.agent.slice(0,6)}…${listing.agent.slice(-4)}` : 'No Agent'}</div>
            <a href="dashboard.html" class="btn btn-primary">Bid</a>
          </div>
        </div>
      `;
    }

    async function refreshListings() {
      const container = document.getElementById('listingsContainer');
      container.innerHTML = `<div class="loading"><div class="spinner"></div><p>Syncing with chain...</p></div>`;
      try {
        const provider = new ethersLib.JsonRpcProvider(PROVIDER_URL);
        const marketplace = new ethersLib.Contract(CONTRACTS.marketplace, marketplaceABI, provider);
        const registry = new ethersLib.Contract(CONTRACTS.titleRegistry, titleABI, provider);
        const total = Number(await marketplace.totalListings());
        if (!total) {
          container.innerHTML = `<div class="empty-state"><h3>No Listings</h3><p>Be the first to list a verified property</p><a class="btn btn-primary" href="dashboard.html">Deploy</a></div>`;
          return;
        }
        allListings = [];
        for (let i = 1; i <= total; i++) {
          try {
            const data = await marketplace.getListing(i);
            if (!data[0]) continue;
            const propertyInfo = await registry.propertyInfo(data[0]);
            const [
              owner,
              status,
              evidenceURI,
              street,
              city,
              state,
              postalCode,
              country,
              exists
            ] = propertyInfo;
            allListings.push({
              id: i,
              propertyId: data[0],
              seller: data[1],
              agent: data[2],
              createdAt: Number(data[3]),
              biddingEnd: Number(data[4]),
              escrowDeadline: Number(data[5]),
              reservePrice: ethersLib.formatEther(data[6]),
              minIncrement: ethersLib.formatEther(data[7]),
              buyNowPrice: data[8] > 0 ? ethersLib.formatEther(data[8]) : 0,
              highestBid: ethersLib.formatEther(data[9]),
              highestBidder: data[10],
              state: Number(data[11]),
              exists: Boolean(data[12]),
              verification: Number(status),
              street,
              city,
              state,
              postalCode,
              country,
              evidenceURI
            });
          } catch (err) {
            console.warn(`Failed to load listing ${i}:`, err.message);
          }
        }
        renderListings();
      } catch (err) {
        container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${err.message}</p><button class="btn btn-primary" onclick="refreshListings()">Retry</button></div>`;
      }
    }

    refreshListings();
  </script>
</body>
</html>
