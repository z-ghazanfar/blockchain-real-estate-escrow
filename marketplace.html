<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transactify Marketplace Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      color-scheme: light;
      --primary: #0a4fd5;
      --secondary: #0f172a;
      --muted: #94a3b8;
      --bg: #f1f5ff;
      --card: #ffffff;
    }
    body {
      margin: 0;
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--secondary);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 4vw;
      background: #fff;
      box-shadow: 0 10px 30px rgba(15,23,42,.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary);
    }
    nav a, nav button {
      margin-left: 12px;
      font-size: 15px;
      text-decoration: none;
      color: var(--primary);
      border: 1px solid rgba(10,79,213,.2);
      padding: 10px 18px;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
    }
    main {
      max-width: 1200px;
      margin: 40px auto 80px;
      padding: 0 4vw;
    }
    h1 {
      margin-bottom: 10px;
      font-size: 42px;
      letter-spacing: -0.5px;
    }
    p.subtitle {
      color: var(--muted);
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 30px;
    }
    .listings-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 12px 35px rgba(15,23,42,.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card h3 {
      margin: 0;
      font-size: 20px;
    }
    .meta {
      color: var(--muted);
      font-size: 14px;
    }
    .pill {
      padding: 4px 12px;
      border-radius: 999px;
      color: white;
      font-size: 13px;
      align-self: flex-start;
    }
    .pill.verified { background: #22c55e; }
    .pill.pending { background: #f59e0b; }
    .pill.rejected { background: #ef4444; }
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .actions button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(10,79,213,.12);
      color: var(--primary);
    }
    #status {
      margin-top: 30px;
      font-family: monospace;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">Transactify</div>
    <nav>
      <a href="index.html">Landing</a>
      <button onclick="window.location.href='dashboard.html'">Launch Dashboard</button>
    </nav>
  </header>

  <main>
    <h1>Live Listings</h1>
    <p class="subtitle">Read-only feed of every property that’s on-chain. Connect your wallet on the dashboard to bid, buy now, or manage escrow.</p>
    <div id="listings" class="listings-grid">
      <div class="card">Loading listings from chain…</div>
    </div>
    <div id="status"></div>
  </main>

  <script>
    const ethersLib = window.ethers;
    const PROVIDER_URL = "https://sepolia.infura.io/v3/YOUR_KEY";
    const CONTRACTS = {
      titleRegistry: "0xYourTitleRegistryAddress",
      marketplace: "0xYourMarketplaceAddress"
    };

    const marketplaceABI = [
      "function totalListings() external view returns(uint256)",
      "function getListing(uint256) external view returns(string,address,address,uint64,uint64,uint64,uint128,uint128,uint128,uint256,address,uint8)"
    ];

    const titleABI = [
      "function propertyInfo(string) external view returns(address,string,uint8,string,bool)"
    ];

    const VERIFY_LABELS = ["None", "Pending", "Verified", "Rejected"];
    const STATE_LABELS = ["Auction","Awaiting Title Transfer","Completed","Refunded","Cancelled"];

    async function init() {
      try {
        const provider = new ethersLib.JsonRpcProvider(PROVIDER_URL);
        const marketplace = new ethersLib.Contract(CONTRACTS.marketplace, marketplaceABI, provider);
        const registry = new ethersLib.Contract(CONTRACTS.titleRegistry, titleABI, provider);
        const container = document.getElementById("listings");
        container.innerHTML = "<div class='card'>Scanning chain…</div>";

        const total = Number(await marketplace.totalListings());
        if (!total) {
          container.innerHTML = "<div class='card'>No listings yet. Sellers can publish from the dashboard.</div>";
          return;
        }

        container.innerHTML = "";
        for (let i = 1; i <= total; i++) {
          try {
            const data = await marketplace.getListing(i);
            const listing = {
              propertyId: data[0],
              seller: data[1],
              agent: data[2],
              createdAt: Number(data[3]),
              biddingEnd: Number(data[4]),
              escrowDeadline: Number(data[5]),
              reservePrice: data[6],
              minIncrement: data[7],
              buyNowPrice: data[8],
              highestBid: data[9],
              state: Number(data[11])
            };
            if (!listing.propertyId) continue;
            const propertyInfo = await registry.propertyInfo(listing.propertyId);
            const verification = Number(propertyInfo[2]);
            const pillClass = verification === 2 ? "pill verified" : verification === 1 ? "pill pending" : "pill rejected";
            const bidStatus = listing.biddingEnd > Date.now() / 1000
              ? `Ends in ${Math.max(0, listing.biddingEnd - Math.floor(Date.now() / 1000))}s`
              : "Auction ended";

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <span class="${pillClass}">${VERIFY_LABELS[verification]}</span>
              <h3>${listing.propertyId}</h3>
              <div class="meta">Seller: ${listing.seller.slice(0,6)}…${listing.seller.slice(-4)}</div>
              <div class="meta">Agent: ${listing.agent === ethersLib.ZeroAddress ? "n/a" : listing.agent.slice(0,6) + "…" + listing.agent.slice(-4)}</div>
              <p><strong>Reserve:</strong> ${ethersLib.formatEther(listing.reservePrice)} ETH</p>
              <p><strong>Highest Bid:</strong> ${ethersLib.formatEther(listing.highestBid)} ETH</p>
              <p><strong>Buy Now:</strong> ${listing.buyNowPrice > 0n ? ethersLib.formatEther(listing.buyNowPrice) + " ETH" : "n/a"}</p>
              <p><strong>Status:</strong> ${STATE_LABELS[listing.state]}</p>
              <p><strong>Bidding:</strong> ${bidStatus}</p>
            `;
            container.appendChild(card);
          } catch (err) {
            console.warn(`Listing ${i} failed`, err);
          }
        }
      } catch (err) {
        document.getElementById("status").textContent = err.message;
      }
    }

    init();
  </script>
</body>
</html>
