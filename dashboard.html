<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactify | Terminal</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #020408;
      --panel: #0f1115;
      --border: #27272a;
      --primary: #3b82f6; 
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --text: #e4e4e7;
      --text-dim: #71717a;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; outline: none; }
    body { background-color: var(--bg); color: var(--text); font-family: var(--font-sans); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    header { border-bottom: 1px solid var(--border); height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; background: rgba(2,4,8,0.9); backdrop-filter: blur(12px); z-index: 50; }
    .brand { font-family: var(--font-mono); font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 10px; color: white; letter-spacing: -0.5px; }
    .connection-status { display: flex; align-items: center; gap: 12px; }
    .role-selector { background: #1f2937; color: #e4e4e7; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-family: var(--font-mono); font-size: 12px; cursor: pointer; }
    .wallet-btn { background: var(--primary); color: white; padding: 8px 16px; border-radius: 6px; font-family: var(--font-mono); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid var(--primary); }
    .wallet-btn:hover { filter: brightness(1.1); }

    .layout { display: flex; flex: 1; overflow: hidden; }
    aside { width: 260px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg); }
    .nav-header { padding: 24px 24px 10px; font-size: 11px; text-transform: uppercase; color: var(--text-dim); font-family: var(--font-mono); font-weight: 700; letter-spacing: 1px; }
    .nav-item { padding: 12px 24px; cursor: pointer; color: var(--text-dim); font-size: 14px; font-weight: 500; transition: 0.2s; display: flex; align-items: center; gap: 12px; border-left: 2px solid transparent; }
    .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
    .nav-item.active { color: white; background: rgba(255,255,255,0.05); border-left-color: var(--primary); }

    main { flex: 1; overflow-y: auto; padding: 40px; position: relative; background: radial-gradient(circle at top right, #172554 0%, transparent 35%); }
    h1 { font-size: 32px; margin: 0 0 8px 0; font-weight: 800; letter-spacing: -1px; }
    p.subtitle { color: var(--text-dim); margin: 0 0 40px 0; font-size: 15px; max-width: 600px; line-height: 1.6; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 24px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: transform 0.2s, border-color 0.2s; position: relative; }
    .card:hover { border-color: #3f3f46; transform: translateY(-2px); }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.01); }
    .card-body { padding: 20px; }
    .prop-id { font-family: var(--font-mono); font-weight: 700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
    .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 4px; font-family: var(--font-mono); text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .status-badge.verified { background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid rgba(16, 185, 129, 0.2); }
    .status-badge.pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
    .status-badge.rejected { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
    .status-badge.live { background: rgba(59, 130, 246, 0.1); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.2); }
    .metric-row { display: flex; justify-content: space-between; margin-bottom: 14px; font-size: 13px; }
    .metric-label { color: var(--text-dim); }
    .metric-val { font-family: var(--font-mono); color: var(--text); }
    .big-price { font-size: 28px; font-weight: 700; margin: 16px 0; color: white; font-family: var(--font-mono); letter-spacing: -1px; }
    .big-price span { font-size: 14px; color: var(--text-dim); font-weight: 400; letter-spacing: 0; }
    .card-footer { padding: 16px 20px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); }

    .btn { background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; width: 100%; }
    .btn:hover { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); background: #333; color: #666; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--text-dim); background: rgba(255,255,255,0.02); }
    .btn-success { background: var(--accent); }
    .btn-danger { background: var(--danger); }

    input { width: 100%; background: #050505; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; font-family: var(--font-mono); font-size: 13px; margin-bottom: 12px; transition: 0.2s; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }

    .terminal { position: fixed; bottom: 0; left: 261px; right: 0; height: 220px; background: #050505; border-top: 1px solid var(--border); font-family: var(--font-mono); font-size: 12px; display: flex; flex-direction: column; z-index: 40; }
    .terminal-header { padding: 10px 16px; background: #111; border-bottom: 1px solid var(--border); color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; font-weight: 600; }
    .terminal-content { flex: 1; overflow-y: auto; padding: 12px 16px; color: #d4d4d8; }
    .log-line { margin-bottom: 8px; display: flex; gap: 12px; line-height: 1.4; }
    .log-time { color: #52525b; white-space: nowrap; }
    .log-source { color: var(--primary); font-weight: bold; min-width: 130px; }
    .log-msg { color: #d4d4d8; word-break: break-all; }
    .log-tx { color: #f59e0b; cursor: pointer; text-decoration: underline; }

    .hidden { display: none !important; }
    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    .pulse-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); animation: pulse-green 2s infinite; }
    @keyframes pulse-green {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    .automation-pill { background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid rgba(16,185,129,0.4); padding: 6px 12px; border-radius: 999px; font-family: var(--font-mono); font-size: 11px; }
  </style>
</head>
<body>

  <header>
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer;"><i data-lucide="box" style="color:var(--primary)"></i> TRANSACTIFY <span>TERMINAL</span></div>
    <div class="connection-status">
      <div class="automation-pill" id="automationStatus">Automation: Standby</div>
      <button class="wallet-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div class="nav-header">Protocol</div>
      <div class="nav-item active" id="nav-market" onclick="switchView('market')"><i data-lucide="shopping-bag"></i> Marketplace</div>
      <div class="nav-item" id="nav-registry" onclick="switchView('registry')"><i data-lucide="file-check"></i> Registry</div>
      <div class="nav-header">Account</div>
      <div class="nav-item" id="nav-portfolio" onclick="switchView('portfolio')"><i data-lucide="wallet"></i> My Properties</div>
      <div class="nav-item" id="nav-agent" onclick="switchView('agent')"><i data-lucide="coins"></i> Commissions</div>
      <div class="nav-header" style="margin-top:auto; border-top:1px solid var(--border)">System Status</div>
      <div class="nav-item" style="color:var(--accent); cursor:default;"><div class="pulse-dot" style="margin-right:10px;"></div> Keeper <span id="keeperStatus">Standby</span></div>
      <div class="nav-item" style="font-size:10px; color:var(--text-dim);">Vault: <span id="vaultBalance">0.00</span> ETH</div>
    </aside>

    <main>
      <!-- MARKETPLACE VIEW -->
      <div id="view-market" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
          <div>
            <h1>Property Market</h1>
            <p class="subtitle">Verified real estate auctions. Escrow logic executes automatically.</p>
          </div>
          <div style="display:flex; gap:10px;">
            <!-- WITHDRAWAL WIDGET -->
            <div class="card" style="padding:8px 16px; min-width:200px; display:flex; align-items:center; justify-content:space-between; background:#111; height:42px; border-color:var(--warning);">
                 <div style="font-size:11px; color:var(--text-dim);">Your Pending Returns: <span id="pendingReturnsVal" style="color:var(--warning); font-weight:700;">0.00</span> ETH</div>
                 <button class="btn btn-outline" style="padding:4px 8px; height:28px; width:auto; font-size:10px; border-color:var(--warning); color:var(--warning);" onclick="withdrawReturns()">Claim</button>
            </div>
            <button class="btn btn-outline" style="width:auto" onclick="refreshData()">
                <i data-lucide="refresh-cw" id="refreshIcon"></i> Refresh
            </button>
          </div>
        </div>
        <div class="grid" id="marketGrid"></div>
      </div>

      <!-- REGISTRY VIEW -->
      <div id="view-registry" class="view-section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h1>Register Title</h1><p class="subtitle">Submit properties for oracle verification. Approved titles can be listed instantly.</p></div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px;">
          <div class="card">
            <div class="card-header"><span class="prop-id">New Application</span><i data-lucide="plus-circle" color="var(--text-dim)"></i></div>
            <div class="card-body">
              <label>Property Address</label><input id="regAddress" placeholder="e.g. 123 Ocean Dr, Miami, FL" oninput="deriveId(this.value)">
              <label>Property ID (Derived)</label><input id="regId" readonly style="color:var(--primary); opacity:0.7; cursor: not-allowed;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>City</label><input id="regCity" placeholder="City"></div>
                <div><label>State</label><input id="regState" placeholder="State"></div>
                <div><label>Zip</label><input id="regZip" placeholder="00000"></div>
                <div><label>Country</label><input id="regCountry" value="USA"></div>
              </div>
              <button class="btn" style="margin-top:10px" onclick="registerProperty()" id="regBtn"><i data-lucide="upload-cloud"></i> Submit for Verification</button>
            </div>
          </div>
          <div class="card" style="border-color:var(--accent); border-style:dashed;">
            <div class="card-header" style="background:rgba(16, 185, 129, 0.05)"><span class="prop-id" style="color:var(--accent)">Oracle Status</span></div>
            <div class="card-body">
              <p style="font-size:13px; color:var(--text-dim); margin-bottom:20px;">
                The verification oracle monitors the <code>VerificationRequested</code> event.
                <br><br>
                <strong>Logic:</strong> Queries US Census Geocoder API. If valid address found, it calls <code>recordVerificationResult</code> on-chain.
              </p>
              <div style="font-size:12px; font-family:var(--font-mono); color:var(--accent);">
                > System Online<br>
                > Census API: Integrated<br>
                > Auto-Signer: Active
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PORTFOLIO VIEW -->
      <div id="view-portfolio" class="view-section hidden">
        <h1>My Properties</h1><p class="subtitle">Properties managed by your wallet address.</p>
        <div class="grid" id="portfolioGrid"></div>
      </div>

      <!-- AGENT VIEW -->
      <div id="view-agent" class="view-section hidden">
        <h1>Commissions</h1><p class="subtitle">Earnings from successful property sales.</p>
        <div class="card" style="max-width:400px">
          <div class="card-header"><span class="prop-id">Available Balance</span><i data-lucide="trending-up" color="var(--accent)"></i></div>
          <div class="card-body" style="text-align:center">
            <div class="big-price" id="agentBalance">0.00 <span>ETH</span></div>
            <button class="btn btn-success" onclick="withdrawCommission()" id="withdrawBtn"><i data-lucide="download"></i> Withdraw</button>
          </div>
        </div>
        <div style="margin-top:20px;">
          <h3 style="margin:10px 0;">Listings where you are the agent</h3>
          <div class="grid" id="agentListingsGrid"></div>
        </div>
      </div>
    </main>

    <div class="terminal">
      <div class="terminal-header"><span>System Logs</span><span style="font-size:10px; opacity:0.5" id="blockNumber">BLOCK: --</span></div>
      <div class="terminal-content" id="terminalLogs"><div class="log-line"><span class="log-time">--:--:--</span> <span class="log-source">[System]</span> <span class="log-msg">Initializing...</span></div></div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const CONTRACT_ADDRESSES = {
      registry: "0x375292e685BAa1e3160a2b99aaeb2F3AAf6BF541", 
      marketplace: "0x53Bfef2fb9BF8b9729dBB35e138dbb8aF20B59a2",
      commission: "0xd2134C54971114178fD737fBec3d10412058E4ea"
    };

    const ABIS = {
      registry: [
        "function registerProperty(string propertyId, string street, string city, string state, string postalCode, string country) external",
        "function recordVerificationResult(string propertyId, bool propertyExists, string evidenceURI) external",
        "function propertyInfo(string propertyId) view returns(address owner, uint8 status, string evidenceURI, string street, string city, string state, string postalCode, string country, bool exists)",
        "function verifier() view returns(address)",
        "function transferOwnership(string propertyId, address newOwner) external",
        "function ownerOf(string propertyId) view returns(address)",
        "event PropertyRegistered(string propertyId, address indexed owner)",
        "event VerificationRequested(string propertyId)"
      ],
      marketplace: [
        "function createListing(string propertyId, uint256 reservePrice, uint256 minIncrement, uint256 buyNowPrice, uint256 biddingDuration, address agent) external returns(uint256)",
        "function placeBid(uint256 listingId) external payable",
        "function finalizeAuction(uint256 listingId) external",
        "function completeEscrow(uint256 listingId) external",
        "function totalListings() view returns(uint256)",
        "function getListing(uint256 listingId) view returns((string propertyId, address seller, address agent, uint64 biddingEnd, uint64 escrowDeadline, uint64 createdAt, uint128 reservePrice, uint128 minIncrement, uint128 buyNowPrice, uint256 highestBid, address highestBidder, uint8 state, bool exists))",
        "function previewEscrowAction(uint256 listingId) view returns (bool canRelease, bool canRefund, uint256 timeRemaining)",
        "function pendingReturns(uint256 listingId, address bidder) view returns(uint256)",
        "function withdrawBid(uint256 listingId) external"
      ],
      commission: [
        "function getCommissionBalance(address agent) view returns(uint256)",
        "function releaseCommission(address payable agent) external"
      ]
    };
    const STATE_LABELS = ["Auction", "Awaiting Transfer", "Completed", "Refunded", "Cancelled"];

    // --- STATE ---
    let provider, signer, userAddress;
    let registry, market, commission;
    let simulationMode = true;

    // Disable on-chain verification + keeper automation from the browser; rely on backend services
    const ENABLE_UI_VERIFIER = false;
    const ENABLE_UI_AUTOMATION = false;

    // MOCK STATE - Re-hydrated from LocalStorage on load
    const MOCK_STATE = {
        listings: [],
        registry: {}
    };
    const verificationAttempts = new Map();
    const VERIFY_COOLDOWN_MS = 60000;
    
    // JSON replacer for BigInt
    function replacer(key, value) {
      if (typeof value === 'bigint') {
        return value.toString();
      }
      return value;
    }

    window.onload = () => {
      lucide.createIcons();
      hydrateMockState();
      if(window.ethereum) {
        window.ethereum.on('accountsChanged', () => window.location.reload());
        window.ethereum.on('chainChanged', () => window.location.reload());
        connectWallet();
      } else {
        connectWallet(); // Init simulation
      }
      if (simulationMode || ENABLE_UI_AUTOMATION) {
        setInterval(autoKeeperBot, 5000);
      }
    };

    function hydrateMockState() {
        const saved = localStorage.getItem('mock_registry');
        if(saved) MOCK_STATE.registry = JSON.parse(saved);
        const listings = localStorage.getItem('mock_listings');
        if(listings) MOCK_STATE.listings = JSON.parse(listings);
        
        if(Object.keys(MOCK_STATE.registry).length === 0) {
            // Seeding demo data
            MOCK_STATE.registry["88-BROADWAY-NY"] = { owner: "0xAlice", status: 2, address: "88 Broadway, New York, NY" };
        }
    }

    function saveMockState() {
        localStorage.setItem('mock_registry', JSON.stringify(MOCK_STATE.registry, replacer));
        localStorage.setItem('mock_listings', JSON.stringify(MOCK_STATE.listings, replacer));
    }

    async function connectWallet() {
      if (!window.ethereum) {
          simulationMode = true;
        userAddress = "0xUser_Simulated";
          const connectBtn = document.getElementById('connectBtn');
          if(connectBtn) connectBtn.innerText = "Simulation Mode";
          setAutomationStatus("Automation: Active (Simulated)", true);
          log("System", "Running in Simulation Mode.");
          refreshData();
          return;
      }
      
      try {
        simulationMode = false;
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        
        registry = new ethers.Contract(CONTRACT_ADDRESSES.registry, ABIS.registry, signer);
        market = new ethers.Contract(CONTRACT_ADDRESSES.marketplace, ABIS.marketplace, signer);
        commission = new ethers.Contract(CONTRACT_ADDRESSES.commission, ABIS.commission, signer);
        
        const connectBtn = document.getElementById('connectBtn');
        if(connectBtn) connectBtn.innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;

        setAutomationStatus("Automation: Active", true);
        
        log("System", `Wallet Connected: ${userAddress}`);
        refreshData();
      } catch (err) {
        console.error(err);
        log("Error", "Connection failed: " + err.message);
      }
    }

    // --- REAL ORACLE LOGIC (CENSUS API) ---
    async function verifyAddressWithCensus(addressStr) {
        const encoded = encodeURIComponent(addressStr);
        const url = `https://geocoding.geo.census.gov/geocoder/locations/onelineaddress?address=${encoded}&benchmark=2020&format=json`;
        try {
            log("Oracle", `Querying Census API: "${addressStr}"...`);
            const res = await fetch(url);
            const data = await res.json();
            const valid = data.result.addressMatches && data.result.addressMatches.length > 0;
            log("Oracle", valid ? "Address Verified." : "Address NOT found.");
            return valid;
        } catch(e) {
            console.error(e);
            // Fallback for demo if CORS fails locally without proxy
            log("Oracle", "API unreachable (CORS). Falling back to mock check.");
            return addressStr.length > 10; 
        }
    }

    // --- AUTOMATION LOGIC ---
    let isProcessing = false;

    async function autoKeeperBot() {
        if (isProcessing) return; 
        
        // 1. Simulation Mode: Everything is automatic
        if (simulationMode) {
            const now = Date.now() / 1000;
            
            // Auto-Finalize Listings
            MOCK_STATE.listings.forEach(l => {
                if(l.state === 0 && now > l.end) {
                    l.state = 1;
                    log("Keeper Bot", `[Sim] Auction #${l.id} finalized.`);
                    saveMockState();
                    refreshData();
                }
            });

            // Auto-Verify Registry Items
            for (const pid of Object.keys(MOCK_STATE.registry)) {
                let prop = MOCK_STATE.registry[pid];
                if (prop && prop.status === 1) { // Pending
                    // Use Real Census Check even in Sim Mode!
                    const isValid = await verifyAddressWithCensus(prop.address);
                    MOCK_STATE.registry[pid].status = isValid ? 2 : 3;
                    log("Oracle", `[Sim] Property ${pid} verification result: ${isValid ? 'VALID' : 'INVALID'}`);
                    saveMockState();
                    refreshData();
                }
            }
            return;
        }

        // 2. Real Mode: optionally run automation; default disabled (use backend bots instead)
        if (!ENABLE_UI_AUTOMATION) return;
        if (!market || !registry || !userAddress) return;

        isProcessing = true;
        try {
            // Check Registry for Pending Items (only if allowed + verifier wallet connected)
            if (ENABLE_UI_VERIFIER) {
                const registryVerifier = await registry.verifier?.();
                const canVerify = registryVerifier ? isSameAddress(registryVerifier, userAddress) : false;
                const savedIds = getSavedProperties();
                for (const pid of savedIds) {
                    try {
                        const p = await registry.propertyInfo(pid);
                        if(Number(p.status) === 1 && canVerify) { // Pending
                            const nowMs = Date.now();
                            const last = verificationAttempts.get(pid) || 0;
                            if (nowMs - last < VERIFY_COOLDOWN_MS) {
                                continue; // backoff to avoid spamming
                            }
                            verificationAttempts.set(pid, nowMs);
                            const isValid = await verifyAddressWithCensus(p.street + " " + p.city + " " + p.state);
                            log("Oracle Bot", `Verifying ${pid} on-chain (Result: ${isValid})...`);
                            
                            // Call Smart Contract
                            const uri = isValid ? "ipfs://census-verified" : "ipfs://rejected";
                            const tx = await registry.recordVerificationResult(pid, isValid, uri);
                            await tx.wait();
                            log("Oracle Bot", `Verification recorded.`);
                            verificationAttempts.delete(pid);
                            refreshData();
                        }
                    } catch(e) {}
                }
            }

            // Check Market for Actions
            const total = await market.totalListings();
            const now = Math.floor(Date.now()/1000);
            
            for(let i=1; i<=total; i++) {
                const l = await market.getListing(i);
                const state = Number(l.state);
                const end = Number(l.biddingEnd);
                const propId = l.propertyId;
                const highestBidder = l.highestBidder;

                // Check 1: Needs Finalize?
                if (state === 0 && now > end) {
                    log("Keeper Bot", `Auction #${i} needs finalization. Sending Tx...`);
                    try {
                        const tx = await market.finalizeAuction(i);
                        await tx.wait();
                        log("Keeper Bot", `Auction #${i} finalized successfully.`);
                        refreshData();
                    } catch(e) { console.log("Finalize skipped/failed", e); }
                }

                // Check 2: Needs Escrow Release?
                if (state === 1) {
                    try {
                        const owner = await registry.ownerOf(propId);
                        if (owner.toLowerCase() === highestBidder.toLowerCase()) {
                            log("Keeper Bot", `Title transfer confirmed for #${i}. Releasing funds...`);
                            const tx = await market.completeEscrow(i);
                            await tx.wait();
                            log("Keeper Bot", `Escrow settled for #${i}.`);
                            refreshData();
                        }
                    } catch(e) { console.log("Escrow check skipped", e); }
                }
            }
        } catch(e) {}
        isProcessing = false;
    }

    // --- ACTIONS ---

    async function registerProperty() {
      const id = document.getElementById('regId').value;
      const street = document.getElementById('regAddress').value;
      if(!id || !street) return alert("Address required");

      setLoading('regBtn', true);
      try {
        if(simulationMode) {
            await new Promise(r => setTimeout(r, 500));
            MOCK_STATE.registry[id] = { owner: userAddress, status: 1, address: street, city: document.getElementById('regCity').value, state: document.getElementById('regState').value };
            saveMockState(); // Persist Sim Data
            saveProperty(id); // Persist User Portfolio
            log("Registry", `Property ${id} registered (Simulated)`);
        } else {
            const tx = await registry.registerProperty(id, street, document.getElementById('regCity').value, document.getElementById('regState').value, "0000", "USA");
            log("Registry", `Tx sent: ${tx.hash}`);
            await tx.wait();
            saveProperty(id);
            log("Registry", `Property ${id} registered.`);
        }
        refreshData();
        switchView('portfolio'); 
      } catch (err) { log("Error", err.reason || err.message); }
      setLoading('regBtn', false);
    }

    async function createListing(id, reserve, durationHours, agentAddr) {
      try {
        const hoursVal = parseFloat(durationHours);
        if (Number.isNaN(hoursVal) || hoursVal <= 0) {
            return alert("Enter a duration in hours (decimals ok).");
        }
        const durationSec = hoursVal * 3600; // Convert hours to seconds
        if (durationSec < 300) {
            return alert("Duration must be at least 5 minutes (0.084 hours).");
        }
        const agent = normalizeAddress(agentAddr || "");
        
        if(simulationMode) {
            MOCK_STATE.listings.push({
                id: MOCK_STATE.listings.length + 1,
                propertyId: id,
                seller: userAddress,
                highestBid: 0n,
                reserve: ethers.parseEther(reserve),
                end: (Date.now()/1000) + durationSec, // Use Calculated Seconds
                biddingEnd: (Date.now()/1000) + durationSec,
                escrowDeadline: 0,
                agent: agent || ethers.ZeroAddress,
                state: 0
            });
            saveMockState();
            log("Market", `Listing active for ${id}`);
        } else {
            // CHANGED: minIncrement is now 0.001 ETH
            const reserveWei = ethers.parseEther(reserve);
            const tx = await market.createListing(
              id,
              reserveWei,
              ethers.parseEther("0.001"),
              0,
              durationSec,
              agent || ethers.ZeroAddress
            );
            log("Market", `Tx sent: ${tx.hash}`);
            await tx.wait();
            log("Market", `Listing active for ${id}`);
        }
        switchView('market');
        refreshData();
      } catch (err) { log("Error", err.reason || err.message); }
    }

    async function placeBid(id, amount) {
      try {
        if(simulationMode) {
            const l = MOCK_STATE.listings.find(x => x.id === id);
            if(l) { 
                l.highestBid = ethers.parseEther(amount); 
                l.highestBidder = userAddress;
                saveMockState();
                log("Market", `Bid ${amount} ETH placed on #${id}`);
            }
        } else {
            const val = ethers.parseEther(amount);
            const tx = await market.placeBid(id, { value: val });
            log("Market", `Tx sent: ${tx.hash}`);
            await tx.wait();
            log("Market", `Bid confirmed!`);
        }
        refreshData();
      } catch (err) { log("Error", err.reason || err.message); }
    }

    async function withdrawReturns() {
        // New function for withdrawals
        try {
            // In this demo, we just show a generic withdraw for the active listing/returns
            // A real impl would iterate all listings or use a specialized contract function
            // For simplicity, we just log it or call withdrawBid on the first listing with returns
            // Check all listings for returns and withdraw from the first one found
            if (!simulationMode) {
              const total = await market.totalListings();
              let found = false;
              for(let i=1; i<=total; i++) {
                  const returns = await market.pendingReturns(i, userAddress);
                  if(returns > 0n) {
                      log("Market", `Withdrawing from Listing #${i}...`);
                      const tx = await market.withdrawBid(i);
                      await tx.wait();
                      log("Market", `Withdrawal Confirmed.`);
                      found = true;
                      break; // Just do one for now
                  }
              }
              if (!found) alert("No pending returns found.");
              refreshData();
            } else {
              alert("Simulated withdrawal of pending returns.");
            }
        } catch(e) { log("Error", e.reason || e.message); }
    }

    async function transferTitle(propId, newOwner) {
        try {
            log("Registry", `Transferring title of ${propId}...`);
            if (simulationMode) {
                if(MOCK_STATE.registry[propId]) MOCK_STATE.registry[propId].owner = newOwner;
                saveMockState();
                log("Registry", `[Sim] Ownership transferred to ${newOwner}`);
            } else {
                const tx = await registry.transferOwnership(propId, newOwner);
                await tx.wait();
                log("Registry", `Ownership transferred! Keeper will settle funds shortly.`);
            }
            refreshData();
        } catch (err) { log("Error", err.reason || err.message); }
    }

    async function withdrawCommission() {
      setLoading('withdrawBtn', true);
      try {
        if(simulationMode) {
            alert("Simulated withdrawal complete.");
        } else {
            const tx = await commission.releaseCommission(userAddress);
            await tx.wait();
            log("Commission", `Withdrawal successful!`);
        }
        refreshData();
      } catch (err) { log("Error", err.reason || err.message); }
      setLoading('withdrawBtn', false);
    }

    // --- RENDERERS ---

    async function refreshData() {
      document.getElementById('refreshIcon').classList.add('loader');
      
      // CLEAR DUPLICATES
      const marketGrid = document.getElementById('marketGrid');
      marketGrid.innerHTML = ''; 
      const portfolioGrid = document.getElementById('portfolioGrid');
      portfolioGrid.innerHTML = '';

      // 1. MARKETPLACE
      let listingsData = [];
      if(simulationMode) {
          listingsData = MOCK_STATE.listings;
      } else {
          try {
            const total = await market.totalListings();
            for(let i=1; i<=total; i++) {
                const l = await market.getListing(i);
                listingsData.push({
                    id: i,
                    propertyId: l[0],
                    seller: l[1],
                    end: Number(l[3]),
                    biddingEnd: Number(l[3]),
                    escrowDeadline: Number(l[4]),
                    createdAt: Number(l[5]),
                    reserve: l[6],
                    highestBid: l[9],
                    highestBidder: l[10],
                    agent: l[2],
                    state: Number(l[11])
                });
            }
          } catch(e) {}
      }

    listingsData.forEach(l => renderListingCard(l, marketGrid));

      // 2. PORTFOLIO
      const savedIds = getSavedProperties();
      if(simulationMode && savedIds.length === 0) {
          savedIds.push("88-BROADWAY-NY");
      }

      for (const pid of [...new Set(savedIds)]) {
          let prop = null;
          if(simulationMode) {
              prop = MOCK_STATE.registry[pid];
          } else {
              try { 
                  const p = await registry.propertyInfo(pid);
                  if (p[8]) { 
                      prop = { owner: p[0], status: Number(p[1]), address: p[3], city: p[4], state: p[5] };
                }
            } catch(e) {}
        }

        if(prop && prop.owner.toLowerCase() === userAddress.toLowerCase()) {
            renderPortfolioCard(pid, prop, portfolioGrid);
        }
      }

      // 3. Agent listings
      const agentGrid = document.getElementById('agentListingsGrid');
      if (agentGrid) agentGrid.innerHTML = '';
      listingsData
        .filter(l => isSameAddress(l.agent || ethers.ZeroAddress, userAddress))
        .forEach(l => renderAgentListingCard(l, agentGrid));

      try {
        if(!simulationMode) {
            // Contract Balance (Vault)
            const balance = await provider.getBalance(CONTRACT_ADDRESSES.marketplace);
            document.getElementById('vaultBalance').innerText = `${ethers.formatEther(balance)} ETH`;

            const bal = await commission.getCommissionBalance(userAddress);
            document.getElementById('agentBalance').innerHTML = `${ethers.formatEther(bal)} <span>ETH</span>`;
            
            // Check for pending returns across all listings to update the UI widget
            let totalReturns = 0n;
            const total = await market.totalListings();
            for(let i=1; i<=total; i++) {
                totalReturns += await market.pendingReturns(i, userAddress);
            }
            document.getElementById('pendingReturnsVal').innerText = ethers.formatEther(totalReturns);
        }
      } catch(e) {}

      document.getElementById('refreshIcon').classList.remove('loader');
      if (window.lucide && typeof window.lucide.createIcons === "function") {
        window.lucide.createIcons();
      }
    }

    function renderListingCard(l, container) {
        const state = Number(l.state); 
        const now = Math.floor(Date.now()/1000);
        const end = Number(l.end || l.biddingEnd || 0);
        const highestBid = ethers.formatEther(l.highestBid || 0n);
        const reserve = ethers.formatEther(l.reserve || l.reservePrice || 0n);
        const timeLeft = end - now;
        const isSeller = isSameAddress(l.seller, userAddress);
        const hasAgent = l.agent && l.agent !== ethers.ZeroAddress;
        
        let badge = '', footer = '';

        if (state === 0) { // Auction
            if(timeLeft > 0) {
                badge = `<span class="status-badge live">LIVE AUCTION</span>`;
                if (isSeller) {
                    footer = `<div style="text-align:center; color:var(--text-dim); font-size:12px;">Your Listing. Active until ${new Date(end*1000).toLocaleTimeString()}</div>`;
                } else {
                    // CHANGED: Display Min Bid logic
                    let minBid;
                    if (Number(highestBid) === 0) {
                       minBid = Number(reserve);
                    } else {
                       minBid = Number(highestBid) + 0.001;
                    }
                    
                    footer = `<div style="display:flex; gap:8px"><input type="number" id="bid_${l.id}" placeholder="Min ${minBid} ETH" step="0.001"><button class="btn" onclick="placeBid(${l.id}, document.getElementById('bid_${l.id}').value)">Bid</button></div>`;
                }
            } else {
                badge = `<span class="status-badge pending">ENDING</span>`;
                footer = `<div style="text-align:center; color:var(--warning); font-size:12px;"><div class="loader" style="display:inline-block; width:10px; height:10px; border:2px solid var(--warning); border-top-color:transparent; border-radius:50%; margin-right:6px;"></div> Waiting for Keeper to Finalize...</div>`;
            }
        } else if (state === 1) { // Escrow
            badge = `<span class="status-badge pending">ESCROW LOCKED</span>`;
            if (isSeller) {
                // SELLER ACTION: Transfer Title
                footer = `<button class="btn" style="background:var(--warning); color:black;" onclick="transferTitle('${l.propertyId}', '${l.highestBidder}')">Action: Transfer Title to Buyer</button>`;
            } else {
                footer = `<div style="text-align:center; color:var(--primary); font-size:12px;">Funds Locked. Waiting for Seller to transfer title.</div>`;
            }
        } else if (state === 2) { // Completed
            badge = `<span class="status-badge verified">SOLD</span>`;
            footer = `<button class="btn" disabled style="background:#1f2937; color:#6b7280;">Transaction Settled</button>`;
        }

        const html = `
            <div class="card">
                <div class="card-header"><span class="prop-id">${l.propertyId}</span>${badge}</div>
                <div class="card-body">
                    <div class="metric-row"><span class="metric-label">Seller</span><span class="metric-val">${l.seller.substring(0,6)}...</span></div>
                    ${hasAgent ? `<div class="metric-row"><span class="metric-label">Agent</span><span class="metric-val">${l.agent.substring(0,6)}...</span></div>` : ``}
                    <div class="big-price">${Number(highestBid) > 0 ? highestBid : reserve} <span>ETH</span></div>
                    <div class="metric-row"><span class="metric-label">${timeLeft > 0 && state === 0 ? 'Time Left' : 'Status'}</span><span class="metric-val">${timeLeft > 0 && state === 0 ? (timeLeft/60).toFixed(2) + ' mins' : 'Closed'}</span></div>
                </div>
                <div class="card-footer">${footer}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function renderAgentListingCard(l, container) {
        if (!container || !l) return;
        const state = Number(l.state);
        const stateLabel = STATE_LABELS[state] || `State ${state}`;
        const reserve = ethers.formatEther(l.reserve || l.reservePrice || 0n);
        const highestBid = ethers.formatEther(l.highestBid || 0n);
        const end = Number(l.end || l.biddingEnd || 0);
        const deadline = Number(l.escrowDeadline || 0);
        const html = `
          <div class="card">
            <div class="card-header">
              <span class="prop-id">${l.propertyId}</span>
              <span class="status-badge ${state === 2 ? 'verified' : state === 1 ? 'pending' : 'live'}">${stateLabel}</span>
            </div>
            <div class="card-body">
              <div class="metric-row"><span class="metric-label">Seller</span><span class="metric-val">${l.seller.substring(0,6)}...</span></div>
              <div class="metric-row"><span class="metric-label">Reserve</span><span class="metric-val">${reserve} ETH</span></div>
              <div class="metric-row"><span class="metric-label">Highest Bid</span><span class="metric-val">${highestBid} ETH</span></div>
              <div class="metric-row"><span class="metric-label">Bidding End</span><span class="metric-val">${end ? new Date(end*1000).toLocaleString() : 'n/a'}</span></div>
              ${deadline ? `<div class="metric-row"><span class="metric-label">Escrow Deadline</span><span class="metric-val">${new Date(deadline*1000).toLocaleString()}</span></div>` : ``}
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function renderPortfolioCard(pid, prop, container) {
        // Handle Status 3 (Rejected) correctly
        const statusLabels = ["None", "Pending", "Verified", "Rejected"];
        const statusClass = ["", "pending", "verified", "rejected"][Number(prop.status)];
        
        let footer = '';
        if(Number(prop.status) === 2) { // Verified
            footer = `
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:8px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <input id="list_res_${pid}" placeholder="ETH" style="margin:0; width:100%;">
                        <input id="list_dur_${pid}" placeholder="Hours" style="margin:0; width:100%;" step="0.01">
                    </div>
                    <input id="list_agent_${pid}" placeholder="Agent 0xâ€¦" style="margin:0; width:100%;">
                    <button class="btn" style="width:100%; justify-content:center;" onclick="createListing('${pid}', document.getElementById('list_res_${pid}').value, document.getElementById('list_dur_${pid}').value, document.getElementById('list_agent_${pid}').value)">List</button>
                </div>
            `;
        } else if (Number(prop.status) === 3) { // Rejected
            footer = `<div style="margin-top:10px; font-size:12px; color:var(--danger); text-align:center;">Verification Failed. Address not found in Census DB.</div>`;
        } else { // Pending
            footer = `<div style="margin-top:10px; font-size:12px; color:var(--warning); text-align:center;"><div class="loader" style="display:inline-block; width:10px; height:10px; border:2px solid var(--warning); border-top-color:transparent; border-radius:50%; margin-right:6px;"></div> Waiting for Verification...</div>`;
        }

        const html = `
            <div class="card">
                <div class="card-header"><span class="prop-id">${pid}</span><span class="status-badge ${statusClass}">${statusLabels[Number(prop.status)]}</span></div>
                <div class="card-body">
                    <div class="metric-row"><span class="metric-label">Location</span><span class="metric-val">${prop.address || prop.city || "Unknown"}</span></div>
                    ${footer}
                </div>
                <div class="card-footer" style="display:flex; gap:8px; border-top:1px solid var(--border); background:rgba(255,255,255,0.02);">
                    <button class="btn btn-outline" style="margin:0; width:100%" onclick="removeProperty('${pid}')"><i data-lucide="trash-2" style="width:14px;height:14px;"></i> Remove</button>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- UTILS ---
    function normalizeAddress(addr) {
        try { return ethers.getAddress(addr); } catch (_) { return ""; }
    }
    function isSameAddress(a, b) {
        return normalizeAddress(a) !== "" && normalizeAddress(a) === normalizeAddress(b);
    }
    function saveProperty(id) {
        let props = JSON.parse(localStorage.getItem('transactify_props') || "[]");
        if(!props.includes(id)) {
            props.push(id);
            localStorage.setItem('transactify_props', JSON.stringify(props));
        }
    }
    function getSavedProperties() { return JSON.parse(localStorage.getItem('transactify_props') || "[]"); }
    function removeProperty(id) {
        // Remove from local saved list
        let props = getSavedProperties().filter(p => p !== id);
        localStorage.setItem('transactify_props', JSON.stringify(props));

        // Remove from sim state
        if (simulationMode) {
            delete MOCK_STATE.registry[id];
            MOCK_STATE.listings = MOCK_STATE.listings.filter(l => l.propertyId !== id);
            saveMockState();
            log("System", `Removed ${id} from portfolio (simulated).`);
            refreshData();
            return;
        }

        // On-chain: cannot delete registry entry; use cancelListing manually if needed
        log("System", `Removed ${id} from local portfolio. On-chain listings remain unchanged.`);
        refreshData();
    }

    function log(source, msg) {
        const term = document.getElementById('terminalLogs');
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = "log-line";
        line.innerHTML = `<span class="log-time">${time}</span><span class="log-source">[${source}]</span><span class="log-msg">${msg}</span>`;
        term.appendChild(line);
        term.scrollTop = term.scrollHeight;
    }
    function setAutomationStatus(text, accent = false) {
        const el = document.getElementById('automationStatus');
        const keeper = document.getElementById('keeperStatus');
        if (el) {
            el.innerText = text;
            el.style.color = accent ? "var(--accent)" : "var(--text-dim)";
            el.style.borderColor = accent ? "rgba(16,185,129,0.4)" : "var(--border)";
            el.style.background = accent ? "rgba(16, 185, 129, 0.1)" : "rgba(255,255,255,0.03)";
        }
        if (keeper) {
            keeper.innerText = accent ? "Active" : "Standby";
            keeper.style.color = accent ? "var(--accent)" : "var(--text-dim)";
        }
    }

    function deriveId(val) { document.getElementById('regId').value = val.toUpperCase().replace(/[^A-Z0-9]+/g, '-').replace(/^-+|-+$/g, ''); }

    function switchView(viewId) {
        // Manually handle active class
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        // Use simpler ID-based activation
        const navMap = {
            'market': 'nav-market',
            'registry': 'nav-registry',
            'portfolio': 'nav-portfolio',
            'agent': 'nav-agent'
        };
        const activeNav = document.getElementById(navMap[viewId]);
        if(activeNav) activeNav.classList.add('active');

        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${viewId}`).classList.remove('hidden');
        refreshData();
    }

    function setLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if(isLoading) { btn.disabled = true; btn.innerHTML = `<i class="loader" data-lucide="loader-2"></i> Processing...`; lucide.createIcons(); }
        else { btn.disabled = false; btn.innerText = "Submit"; }
    }
  </script>
</body>
</html>
